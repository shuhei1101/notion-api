name: CI for Service and Job Docker Images

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Authenticate with Google Cloud using the service account
    - id: "auth"
      uses: "google-github-actions/auth@v2"
      with:
        credentials_json: "${{ secrets.GCP_SA_KEY }}"

    # Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # Build and test service docker image
    - name: Build service docker image
      run: |
        SERVICE_IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPO_NAME }}/${{ secrets.SERVICE_NAME }}-service"
        docker build --no-cache -t $SERVICE_IMAGE -f Dockerfile.service --build-arg NOTION_TOKEN=${{ secrets.NOTION_TOKEN }} .
        docker run --rm $SERVICE_IMAGE npm run test  # Adjust the test command as needed

    # Build and test job docker image
    - name: Build job docker image
      run: |
        JOB_IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPO_NAME }}/${{ secrets.SERVICE_NAME }}-job"
        docker build --no-cache -t $JOB_IMAGE -f Dockerfile.job --build-arg NOTION_TOKEN=${{ secrets.NOTION_TOKEN }} .
        docker run --rm $JOB_IMAGE npm run test  # Adjust the test command as needed
